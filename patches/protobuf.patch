diff --git a/CMakeLists.txt b/CMakeLists.txt
new file mode 100644
index 000000000..3eb6f897b
--- /dev/null
+++ b/CMakeLists.txt
@@ -0,0 +1,3 @@
+cmake_minimum_required(VERSION 3.0)
+include(flags OPTIONAL)
+add_subdirectory(cmake)
diff --git a/cmake/CMakeLists.txt b/cmake/CMakeLists.txt
index 8e5e68073..114c525ee 100644
--- a/cmake/CMakeLists.txt
+++ b/cmake/CMakeLists.txt
@@ -107,7 +107,20 @@ if (CMAKE_USE_PTHREADS_INIT)
 endif (CMAKE_USE_PTHREADS_INIT)
 
 set(_protobuf_FIND_ZLIB)
-if (protobuf_WITH_ZLIB)
+include(CheckLibraryExists)
+check_library_exists(rt sched_yield "${CMAKE_LIBRARY_PATH}" HAVE_LIBRT)
+if (HAVE_LIBRT)
+  set(SYSTEM_LIBRARIES rt)
+endif ()
+option(ZLIB_MODULE_PATH "Find zlib in CMAKE_MODULE_PATH" OFF)
+mark_as_advanced(ZLIB_MODULE_PATH)
+if (ZLIB_MODULE_PATH)
+  find_package(usexp-ZLIB REQUIRED PATHS ${CMAKE_MODULE_PATH} NO_DEFAULT_PATH)
+  if (ZLIB_FOUND)
+    set(HAVE_ZLIB 1)
+    set(ZLIB_INCLUDE_DIRECTORIES ${ZLIB_INCLUDE_DIRS})
+  endif (ZLIB_FOUND)
+elseif (protobuf_WITH_ZLIB)
   find_package(ZLIB)
   if (ZLIB_FOUND)
     set(HAVE_ZLIB 1)
@@ -126,7 +139,7 @@ if (protobuf_WITH_ZLIB)
     set(ZLIB_INCLUDE_DIRECTORIES)
     set(ZLIB_LIBRARIES)
   endif (ZLIB_FOUND)
-endif (protobuf_WITH_ZLIB)
+endif ()
 
 if (HAVE_ZLIB)
   add_definitions(-DHAVE_ZLIB)
@@ -232,6 +245,15 @@ if (protobuf_UNICODE)
   add_definitions(-DUNICODE -D_UNICODE)
 endif (protobuf_UNICODE)
 
+if(NOT DEFINED PROTOBUF_VER)
+  set(PROTOBUF_VER ${protobuf_VERSION})
+elseif(NOT ${PROTOBUF_VER} STREQUAL ${protobuf_VERSION})
+  message(AUTHOR_WARNING "version passed in (${PROTOBUF_VER}) doesn't match internal version (${protobuf_VERSION})")
+endif()
+set(ver _${PROTOBUF_VER})
+set(verDir /${PROJECT_NAME}${ver})
+set(CMAKE_INSTALL_INCLUDEDIR include${verDir})
+
 include(libprotobuf-lite.cmake)
 include(libprotobuf.cmake)
 if (protobuf_BUILD_PROTOC_BINARIES)
diff --git a/cmake/install.cmake b/cmake/install.cmake
index be47c54a1..0cad0749b 100644
--- a/cmake/install.cmake
+++ b/cmake/install.cmake
@@ -117,6 +117,15 @@ configure_file(protobuf-module.cmake.in
   ${CMAKE_INSTALL_CMAKEDIR}/protobuf-module.cmake @ONLY)
 configure_file(protobuf-options.cmake
   ${CMAKE_INSTALL_CMAKEDIR}/protobuf-options.cmake @ONLY)
+  
+install(FILES 
+  ${CMAKE_CURRENT_BINARY_DIR}/${CMAKE_INSTALL_CMAKEDIR}/protobuf-config.cmake
+  ${CMAKE_CURRENT_BINARY_DIR}/${CMAKE_INSTALL_CMAKEDIR}/protobuf-config-version.cmake
+  ${CMAKE_CURRENT_BINARY_DIR}/${CMAKE_INSTALL_CMAKEDIR}/protobuf-module.cmake
+  ${CMAKE_CURRENT_BINARY_DIR}/${CMAKE_INSTALL_CMAKEDIR}/protobuf-options.cmake
+  DESTINATION "lib/cmake/protobuf${ver}"
+  COMPONENT protobuf-export
+  )
 
 # Allows the build directory to be used as a find directory.
 
@@ -133,7 +142,7 @@ else (protobuf_BUILD_PROTOC_BINARIES)
 endif (protobuf_BUILD_PROTOC_BINARIES)
 
 install(EXPORT protobuf-targets
-  DESTINATION "${CMAKE_INSTALL_CMAKEDIR}"
+  DESTINATION "lib/cmake/protobuf${ver}"
   NAMESPACE protobuf::
   COMPONENT protobuf-export)
 
diff --git a/cmake/libprotobuf-lite.cmake b/cmake/libprotobuf-lite.cmake
index 6bf86a277..dc3be483f 100644
--- a/cmake/libprotobuf-lite.cmake
+++ b/cmake/libprotobuf-lite.cmake
@@ -75,6 +75,6 @@ if(MSVC AND protobuf_BUILD_SHARED_LIBS)
 endif()
 set_target_properties(libprotobuf-lite PROPERTIES
     VERSION ${protobuf_VERSION}
-    OUTPUT_NAME ${LIB_PREFIX}protobuf-lite
+    OUTPUT_NAME ${LIB_PREFIX}protobuf-lite${ver}
     DEBUG_POSTFIX "${protobuf_DEBUG_POSTFIX}")
 add_library(protobuf::libprotobuf-lite ALIAS libprotobuf-lite)
diff --git a/cmake/libprotobuf.cmake b/cmake/libprotobuf.cmake
index 0c12596c2..2a817afd1 100644
--- a/cmake/libprotobuf.cmake
+++ b/cmake/libprotobuf.cmake
@@ -129,6 +129,6 @@ if(MSVC AND protobuf_BUILD_SHARED_LIBS)
 endif()
 set_target_properties(libprotobuf PROPERTIES
     VERSION ${protobuf_VERSION}
-    OUTPUT_NAME ${LIB_PREFIX}protobuf
+    OUTPUT_NAME ${LIB_PREFIX}protobuf${ver}
     DEBUG_POSTFIX "${protobuf_DEBUG_POSTFIX}")
 add_library(protobuf::libprotobuf ALIAS libprotobuf)
diff --git a/cmake/libprotoc.cmake b/cmake/libprotoc.cmake
index b71f2f1ba..600396c69 100644
--- a/cmake/libprotoc.cmake
+++ b/cmake/libprotoc.cmake
@@ -176,7 +176,7 @@ endif()
 set_target_properties(libprotoc PROPERTIES
     COMPILE_DEFINITIONS LIBPROTOC_EXPORTS
     VERSION ${protobuf_VERSION}
-    OUTPUT_NAME ${LIB_PREFIX}protoc
+    OUTPUT_NAME ${LIB_PREFIX}protoc${ver}
     DEBUG_POSTFIX "${protobuf_DEBUG_POSTFIX}")
 add_library(protobuf::libprotoc ALIAS libprotoc)
 
diff --git a/cmake/protoc.cmake b/cmake/protoc.cmake
index f90e525e8..70ba28d90 100644
--- a/cmake/protoc.cmake
+++ b/cmake/protoc.cmake
@@ -11,6 +11,10 @@ endif()
 add_executable(protoc ${protoc_files} ${protoc_rc_files})
 target_link_libraries(protoc libprotoc libprotobuf)
 add_executable(protobuf::protoc ALIAS protoc)
+set_target_properties(protoc PROPERTIES
+  DEBUG_POSTFIX "${CMAKE_DEBUG_POSTFIX}"
+  OUTPUT_NAME protoc${ver}
+)
 
 set_target_properties(protoc PROPERTIES
     VERSION ${protobuf_VERSION})
